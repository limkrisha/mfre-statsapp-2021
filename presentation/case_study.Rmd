---
title: "Case Study: Preview"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: lumen
---

```{r pacman_run, echo = FALSE}
pacman::p_load(tidyverse, readxl, googlesheets4, readstata13, magrittr, cansim, Quandl, stats, broom, modelsummary, here)
```

# Introduction

Test test 

Carbon dioxide is one of the main greenhouse gases emitted by human activities. As the concentration of greenhouse gases changed over time because of human activities, the world also has experienced rising global temperatures. 

In this case study, we explore the factors that contribute to rising carbon emissions over time. In particular, we will look at 3 factors: GDP per capita, energy use per capita, and the political climate of a country.

# Data

We will use the cleaned data from the R bootcamp. 

```{r load_data, include = FALSE}
data <-read_csv(here("data", "dataforanalysis.csv"))
```

The data consists of carbon emissions, GDP per capita, and political regime of 192 countries from 1990-2014. Carbon emissions is measured at metric tons per person. GDP is measured as real GDP per capita. The liberal democracy index is an index that measures the extent that the ideal of liberal democracy is achieved. The higher the value,  the more a state emphasizes the "importance of protecting individual and minority rights against the tyranny of the state and the tyranny of the majority." There are 4 possible regimes -- closed autocracy, electoral autocracy, electoral democracy, and liberal democracy. More information about the political variables [here](https://www.v-dem.net/en/data/data/v-dem-dataset-v111/).

# Basic data visualization

It is good practice to visualize the data you are working with. 

```{r dataviz_emissions_time, message = FALSE, warning = FALSE}
data %>% group_by(year) %>%
  summarize(Emissions = sum(emissions, na.rm = T)) %>%
  ggplot(aes(x = year, y = Emissions)) +
  geom_line(size = 1.5) +
  labs(title = "World" ~CO[2]~ "Emissions per year (1751- 2014)",
       y = "Emissions (Metric Tonnes)") +
  theme_classic()
```

```{r dataviz_emissions_country, message = FALSE, warning = FALSE}
data %>% group_by(year, country) %>%
  summarize(Emissions = sum(emissions, na.rm = T)) %>%
  ggplot(aes(x = year, y = Emissions, group = country)) +
  geom_line(alpha = 0.4) +
  labs(title = "World" ~CO[2]~ "Emissions per year (1751- 2014)",
       y = "Emissions (Metric Tonnes)") +
  theme_classic()
```

The graph shows that countries who scored lower on the liberal democracy index tend to have higher emissions. 

```{r dataviz_emissions_politics, message = FALSE, warning = FALSE}
data %>%
  ggplot(aes(x = v2x_libdem, y = emissions, color = v2x_regime)) + geom_point()
```
Some countries with lower GDP per capita have higher emissions. Countries with higher higher GDP per capita have lower emissions. When we added a trend line, we see that there appears to be a positive relationship between GDP per capita and emissions per capita.

```{r dataviz_emissions_region_ols, message = FALSE, warning = FALSE}
data %>% 
  ggplot(aes(x = gdp_pc, y = emissions)) + geom_point() + geom_smooth(method = "lm")
```

```{r hist, message = FALSE, warning = FALSE}
hist(data$gdp_pc)

hist(log(data$gdp_pc))

hist(data$emissions)

hist(log(data$emissions))
```

# Summary statistics

```{sumstats}
datasummary_skim(data)
```

# Regressions

Let's first take a look at a simple linear model. In this case, $emissions_i$ is our outcome or dependent variable, and $GDP$ is our explanatory or independent variable. The equation is an example of a statistical relationship because you might expect that emissions fall as GDP increases, but not perfectly. 

$$ 
emissions_i = b_0 + b_1 GDP_i + \varepsilon_i 
$$
To run an OLS regression, we use the `lm()` function of the `stats` package. The syntax is `lm(y ~ x1 + x2 + x3 + ...)` Printing the object will only give you the coefficients. 

```{r reg1}
reg1 <- lm(emissions ~ gdp_pc, data = data)
reg1
```

To get all the details of the regression, we use the `summary()` function. The output is similar to Stata's regression output. To extract elements of the regression results, you can use the command `str(summary(reg1))`

```{r reg1summary}
summary(reg1)
```

The intercept $b_0$ tells us that when GDP = 0 the predicted value for emissions per capita is `r round(summary(reg1)$coefficients[1],2)`. This prediction is not meaningful for our case study because this value is beyond the scope of the model, i.e. we don't have an observation with GDP = 0. 

The coefficient $b_1$ tells us that we predict the mean emissions per capita to increase by `r round(summary(reg1)$coefficients[2],2)` for every dollar increase in GDP per capita. Since its p-value = `r round(summary(reg1)$coefficients[2,4], 2)` and is < 0.05, we can reject the null hypothesis that $b_1$ is equal to zero (no effect). 

The $r^2$ can be interpreted as as `r round((summary(reg1)$r.squared *100), 2)` percent of the variation in emissions is explained by the variation in GDP per capita. 

The Pearson correlation coefficient can be calculated as follows

```{r corr}
cor <- cor.test(data$emissions, data$gdp_pc, method = "pearson")
# str(cor)
```

The correlation coefficient of `r round(cor$estimate,2)` with a p-value of `r round(cor$p.value,2)` that the relationship between emissions per capita and GDP per capita is positive but the relationship is not as strong (not close to 1), although it is statistically significant. 

Should we talk about MSE?
```{mse}
sum(residuals(reg1)^2)

mse <- function(reg){
  mean(residuals(reg1)^2)
}

mse(reg1)
```

# Multiple linear regression 

Now let's add more predictors to our model. Based on the literature, there is an inverse U-share relationship between emissions and GDP per capita. In addition, different political climate may affect a country's level of emissions as well. 

The statistical relationship we want to investigate can be defined as:

$$
ln emissions_i = b_0 + b_1 ln GDP_i + b_2(lnGDP_i)^2 + b_3PoliticalRegime + \varepsilon_i
$$

We take the natural logarithm of emissions and GDP because these variables are highly skewed. Taking their natural logs also allows for easier interpretation of results [add more]. 

```{r reg2}
reg2 <- lm(log(emissions) ~ log(gdp_pc) + I(log(gdp_pc)^2) + v2x_regime, data = data)
summary(reg2)
```

Similar to the simple linear model, we can interpret each $\beta$ paratmeter as follows: For every one unit change in the explanatory variable, the estimated change in the mean emissions is $b_i$. Because we are using natural logs for both the independent (emissions) and dependent (GDP) variables, we can interpret it as elasticity (more info [here](https://stats.idre.ucla.edu/sas/faq/how-can-i-interpret-log-transformed-variables-in-terms-of-percent-change-in-linear-regression/)), such that $b_i$ represents the percent change in emissions as the explanatory variable increases by one percent. 

A one percent increase in GDP increases emissions by `r round(summary(reg1)$coefficients[2], 2)` percent. Because the coefficient for $(lnGDP_i)^2$ is negative, we can say that after a certain income threshold, emissions decrease.

We see that there are 3 coefficients for the `regime` variable. When you put a categorical variable in a linear regression, you get a different intercept for each level of that variable. In other words, countries in our data are categorized into 4 political regimes, and our model specifies the same slope for how emissions change with GDP per capita, but with different starting point or intercept based on the country's political regime. 

The regime variable is a categorical variable, and like Stata, it will automatically drop one level. We interpret the results in reference to that category.  

# Model Evaluation


# References
Wright, Carrie and Ontiveros, Michael and Jager, Leah and Taub, Margaret and Hicks, Stephanie. (2020). https://github.com/opencasestudies/ocs-bp-co2-emissions. Exploring CO2 emissions across time (Version v1.0.0). 